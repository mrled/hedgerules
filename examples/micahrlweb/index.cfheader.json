{{- /* The _cfheaders.json file template.

Outputs a JSON file mapping paths to objects of HTTP headers.
Format: {"/path/*": {"Header-Name": "value", "Another-Header": "value"}}
Headers may include the special token {/path}, which means the response path with a leading slash.

*/ -}}

{{- /* Start with an empty dict of headers */ -}}
{{- $headers := dict -}}

{{- /* Handle the headers we define programmatically, like Onion-Location. */ -}}
{{- if .Site.Params.OnionLocationRoot -}}
  {{- $path := "/" -}}
  {{- $onionLocationValue := printf "%s{/path}" .Site.Params.OnionLocationRoot -}}
  {{- /* Get existing headers for this path, or empty dict */ -}}
  {{- $existingHeaders := dict -}}
  {{- if isset $headers $path -}}
    {{- $existingHeaders = index $headers $path -}}
  {{- end -}}
  {{- /* Create new header dict and merge with existing */ -}}
  {{- $newHeaders := dict "Onion-Location" $onionLocationValue -}}
  {{- $pathHeaders := merge $existingHeaders $newHeaders -}}
  {{- /* Update headers */ -}}
  {{- $headers = merge $headers (dict $path $pathHeaders) -}}
{{- end -}}

{{- /* Merge all non-page-path headers, which are defined in a single place in the global site config */ -}}
{{- range $path, $headerDict := .Site.Params.CloudFrontNonPagePathHeaders -}}
  {{- /* Headers are already in dict format, just merge with existing */ -}}
  {{- $existingHeaders := dict -}}
  {{- if isset $headers $path -}}
    {{- $existingHeaders = index $headers $path -}}
  {{- end -}}
  {{- $pathHeaders := merge $existingHeaders $headerDict -}}
  {{- $headers = merge $headers (dict $path $pathHeaders) -}}
{{- end -}}

{{- /* Merge all page headers, which are defined in page frontmatter */ -}}
{{- range .Site.Pages -}}
  {{- $path := .RelPermalink -}}
  {{- $headerDict := dict -}}
  {{- if .Params.CloudFrontHeaders -}}
    {{- /* Headers are already in dict format, just merge */ -}}
    {{- $headerDict = merge $headerDict .Params.CloudFrontHeaders -}}
  {{- end -}}
  {{- if gt (len $headerDict) 0 -}}
    {{- /* Merge with existing headers for this path */ -}}
    {{- $existingHeaders := dict -}}
    {{- if isset $headers $path -}}
      {{- $existingHeaders = index $headers $path -}}
    {{- end -}}
    {{- $pathHeaders := merge $existingHeaders $headerDict -}}
    {{- $headers = merge $headers (dict $path $pathHeaders) -}}
  {{- end -}}
{{- end -}}

{{- /* Output all the headers as JSON */ -}}
{{ $headers | jsonify (dict "indent" "  ") -}}
