{{- /* The _cfheaders.json file template.

Outputs a JSON file mapping paths to objects of HTTP headers.
Format: {"/path/": {"Header-Name": "value"}, "/": {"Default-Header": "value"}}

Header sources (merged in this order, later wins):
1. params.CloudFrontNonPagePathHeaders from hugo.toml (root "/" for global defaults)
2. CloudFrontHeaders from page frontmatter (exact page paths)

The viewer-response function does two KVS lookups: exact path, then root "/".
Exact-path headers take priority over root defaults.

*/ -}}

{{- /* Start with an empty dict of headers */ -}}
{{- $headers := dict -}}

{{- /* Merge all non-page-path headers from site config */ -}}
{{- range $path, $headerDict := .Site.Params.CloudFrontNonPagePathHeaders -}}
  {{- $existingHeaders := dict -}}
  {{- if isset $headers $path -}}
    {{- $existingHeaders = index $headers $path -}}
  {{- end -}}
  {{- $pathHeaders := merge $existingHeaders $headerDict -}}
  {{- $headers = merge $headers (dict $path $pathHeaders) -}}
{{- end -}}

{{- /* Merge all page headers from frontmatter */ -}}
{{- range .Site.Pages -}}
  {{- $path := .RelPermalink -}}
  {{- $headerDict := dict -}}
  {{- if .Params.CloudFrontHeaders -}}
    {{- $headerDict = merge $headerDict .Params.CloudFrontHeaders -}}
  {{- end -}}
  {{- if gt (len $headerDict) 0 -}}
    {{- $existingHeaders := dict -}}
    {{- if isset $headers $path -}}
      {{- $existingHeaders = index $headers $path -}}
    {{- end -}}
    {{- $pathHeaders := merge $existingHeaders $headerDict -}}
    {{- $headers = merge $headers (dict $path $pathHeaders) -}}
  {{- end -}}
{{- end -}}

{{- /* Output all the headers as JSON */ -}}
{{ $headers | jsonify (dict "indent" "  ") -}}
